import { TransformWrapExportFilter } from "@hiogawa/transforms";
import MagicString from "magic-string";
import { Plugin, ViteDevServer, parseAstAsync } from "vite";

//#region src/plugin.d.ts
type RscPluginOptions = {
  /**
  * shorthand for configuring `environments.(name).build.rollupOptions.input.index`
  */
  entries?: Partial<Record<"client" | "ssr" | "rsc", string>>;
  /** @deprecated use `serverHandler: false` */
  disableServerHandler?: boolean;
  /** @default { enviornmentName: "rsc", entryName: "index" } */
  serverHandler?: {
    environmentName: string;
    entryName: string;
  } | false;
  /** @default false */
  loadModuleDevProxy?: boolean;
  rscCssTransform?: false | {
    filter?: (id: string) => boolean;
  };
};
declare function vitePluginRsc(rscPluginOptions?: RscPluginOptions): Plugin[];
//
// collect client reference dependency chunk for modulepreload
//
type AssetsManifest = {
  bootstrapScriptContent: string;
  clientReferenceDeps: Record<string, AssetDeps>;
  serverResources?: Record<string, {
    css: string[];
  }>;
};
type AssetDeps = {
  js: string[];
  css: string[];
};
//
// support findSourceMapURL
// https://github.com/facebook/react/pull/29708
// https://github.com/facebook/react/pull/30741
//
declare function vitePluginFindSourceMapURL(): Plugin[];
declare function findSourceMapURL(server: ViteDevServer, filename: string, environmentName: string): Promise<object | undefined>;
//
// css support
//
declare function vitePluginRscCss(rscCssOptions?: Pick<RscPluginOptions, "rscCssTransform">): Plugin[];
declare function transformRscCssExport(options: {
  ast: Awaited<ReturnType<typeof parseAstAsync>>;
  code: string;
  id?: string;
  filter: TransformWrapExportFilter;
}): Promise<{
  output: MagicString;
} | undefined>;
/** temporary workaround for https://github.com/cloudflare/workers-sdk/issues/9538 */
declare function __fix_cloudflare(): Plugin;
//#endregion
export { AssetDeps, AssetsManifest, __fix_cloudflare, vitePluginRsc as default, findSourceMapURL, transformRscCssExport, vitePluginFindSourceMapURL, vitePluginRscCss };